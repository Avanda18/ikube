<project name="Deploy Ikube Cluster" default="start">

	<property file="build.properties" />

	<target name="all">
		<antcall target="deploy" />
		<antcall target="start" />
	</target>

	<target name="start">
		<antcall target="executeTomcatAction">
			<param name="action" value="start" />
			<param name="tomcat.bin" value="${tomcat.1.bin}" />
			<param name="tomcat.home" value="${tomcat.1}" />
		</antcall>
		<!-- sleep seconds="${sleep}" />
		<antcall target="executeTomcatAction">
			<param name="action" value="start" />
			<param name="tomcat.bin" value="${tomcat.2.bin}" />
			<param name="tomcat.home" value="${tomcat.2}" />
		</antcall>
		<sleep seconds="${sleep}" />
		<antcall target="executeTomcatAction">
			<param name="action" value="start" />
			<param name="tomcat.bin" value="${tomcat.3.bin}" />
			<param name="tomcat.home" value="${tomcat.3}" />
		</antcall -->
	</target>
	<target name="stop">
		<antcall target="executeTomcatAction">
			<param name="action" value="stop" />
			<param name="tomcat.bin" value="${tomcat.1.bin}" />
			<param name="tomcat.home" value="${tomcat.1}" />
		</antcall>
		<antcall target="executeTomcatAction">
			<param name="action" value="stop" />
			<param name="tomcat.bin" value="${tomcat.2.bin}" />
			<param name="tomcat.home" value="${tomcat.2}" />
		</antcall>
		<antcall target="executeTomcatAction">
			<param name="action" value="stop" />
			<param name="tomcat.bin" value="${tomcat.3.bin}" />
			<param name="tomcat.home" value="${tomcat.3}" />
		</antcall>
	</target>

	<target name="executeTomcatAction">
		<echo message="Bin: ${tomcat.bin}, Home: ${tomcat.home}" />
		<java jar="${tomcat.bin}/bootstrap.jar" dir="${tomcat.bin}" fork="yes" spawn="true">
			<jvmarg value="-Dcatalina.home=${tomcat.home}" />
			<jvmarg value="-XX:PermSize=128m" />
			<jvmarg value="-XX:MaxPermSize=512m" />
			<jvmarg value="-Xms2048m" />
			<jvmarg value="-Xmx4096m" />
			<arg line="${action}" />
		</java>
	</target>
	
	<target name="startJenkins">
		<echo message="Bin: ${jenkins.bin}, Home: ${jenkins.home}" />
		<java jar="${jenkins.bin}/bootstrap.jar" dir="${jenkins.bin}" fork="yes" spawn="true">
			<jvmarg value="-Dcatalina.home=${jenkins.home}" />
			<jvmarg value="-XX:PermSize=32m" />
			<jvmarg value="-XX:MaxPermSize=128m" />
			<jvmarg value="-Xms512m" />
			<jvmarg value="-Xmx2048m" />
			<arg line="start" />
		</java>
	</target>

	<target name="deploy">
		<!-- delete dir="${indexes.directory}" failonerror="false" / -->
		<delete dir="${tomcat.1}/webapps/ikube" failonerror="false" />
		<delete dir="${tomcat.2}/webapps/ikube" failonerror="false" />
		<delete dir="${tomcat.3}/webapps/ikube" failonerror="false" />
		<copy file="${target.directory}/${ikube.war}" todir="${tomcat.1}/webapps" overwrite="true" failonerror="false" />
		<copy file="${target.directory}/${ikube.war}" todir="${tomcat.2}/webapps" overwrite="true" failonerror="false" />
		<copy file="${target.directory}/${ikube.war}" todir="${tomcat.3}/webapps" overwrite="true" failonerror="false" />
	</target>

	<target name="startUbuntu">
		<exec executable="cmd">
			<arg value="VBoxManage" />
			<arg value="startvm" />
			<arg value="Ubuntu 11.4" />
		</exec>
	</target>
</project>