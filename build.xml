<project name="Deploy Ikube Cluster" default="go">

	<property file="build.properties" />
	<property file="local-build.properties" />

	<!-- The default profile to deploy. -->
	<property name="profile" value="production" />
	<property name="user-dir" value="${user.dir}" />
	<property name="user-home" value="${user.home}" />

	<target name="go">
		<antcall target="prepare" />
		<antcall target="stop-servers" />
		<!-- Deploy the configuration and ikube and start the servers -->
		<antcall target="go-server" inheritall="true">
			<param name="server-ip" value="ikube.be" />
			<param name="tomcat-home" value="/usr/share/apache-tomcat-6.0.29-1" />
		</antcall>
		<!-- antcall target="go-server" inheritall="true">
			<param name="server-ip" value="192.168.1.6" />
			<param name="tomcat-home" value="/usr/share/apache-tomcat-6.0.29-1" />
		</antcall>
		<antcall target="go-server" inheritall="true">
			<param name="server-ip" value="192.168.1.7" />
			<param name="tomcat-home" value="/usr/share/apache-tomcat-6.0.29-1" />
		</antcall -->
	</target>

	<target name="stop-servers">
		<!-- Stop all the processes, the only way to stop Tomcat -->
		<antcall target="execute-remote-command">
			<param name="server-ip" value="ikube.be" />
			<param name="command" value="cd /usr/share/apache-tomcat-6.0.29-1/bin; ./shutdown.sh;" />
		</antcall>
		<sleep seconds="15" />
		<!-- antcall target="execute-remote-command">
			<param name="server-ip" value="192.168.1.6" />
			<param name="command" value="killall java" />
		</antcall>
		<sleep seconds="15" />
		<antcall target="execute-remote-command">
			<param name="server-ip" value="192.168.1.7" />
			<param name="command" value="killall java" />
		</antcall>
		<sleep seconds="15" / -->
	</target>

	<target name="deploy-site">
		<antcall target="execute-remote-command">
			<param name="server-ip" value="ikube.be" />
			<param name="command" value="cd /usr/share/apache-tomcat-7.0.27/bin; ./shutdown.sh;" />
		</antcall>
		<sleep seconds="15" />
		<antcall target="execute-remote-command">
			<param name="server-ip" value="ikube.be" />
			<param name="command" value="
				rm -r /usr/share/apache-tomcat-7.0.27/webapps/site*;
				rm -r /usr/share/apache-tomcat-7.0.27/logs;
				mkdir -p /usr/share/apache-tomcat-7.0.27/logs;" />
		</antcall>
		<antcall target="deploy-ikube-site">
			<param name="server-ip" value="ikube.be" />
			<param name="tomcat-home" value="/usr/share/apache-tomcat-7.0.27" />
		</antcall>
		<antcall target="execute-remote-command">
			<param name="server-ip" value="ikube.be" />
			<param name="command" value="
				chmod 777 -R /usr/share/apache-tomcat-7.0.27;
				cd /usr/share/apache-tomcat-7.0.27/bin; ./startup.sh;" />
		</antcall>
	</target>

	<target name="deploy-ikube-site">
		<scp file="code/site/target/site.war" todir="${userid}:${password}@${server-ip}:${tomcat-home}/webapps" trust="true" failonerror="false" verbose="${verbose}" />
	</target>

	<target name="go-server">
		<!-- Clean all the output folders and the configuration -->
		<antcall target="execute-remote-command">
			<param name="server-ip" value="${server-ip}" />
			<param name="command" value="
				rm -r ${tomcat-home}/bin/ikube;
				rm -r ${tomcat-home}/webapps/ikube*;
				rm -r ${tomcat-home}/logs;
				mkdir -p ${tomcat-home}/bin/ikube;
				mkdir -p ${tomcat-home}/logs;" />
		</antcall>
		<!-- Deploy the configuration to the server -->
		<antcall target="copy-directory-to-server">
			<param name="server-ip" value="${server-ip}" />
			<param name="directory-to-copy" value="${configuration-directory}" />
			<param name="server-directory" value="${tomcat-home}/bin/ikube" />
		</antcall>
		<!-- Deploy Ikube to the server -->
		<antcall target="copy-file-to-server">
			<param name="file-to-copy" value="${target-directory}/${ikube-war}" />
			<param name="server-directory" value="${tomcat-home}/webapps" />
		</antcall>
		<!-- Change the directory permissions just in case -->
		<antcall target="execute-remote-command">
			<param name="server-ip" value="${server-ip}" />
			<param name="command" value="chmod 777 -R ${tomcat-home};" />
		</antcall>
		<!-- Start the server -->
		<antcall target="execute-remote-command">
			<param name="server-ip" value="${server-ip}" />
			<param name="command" value="cd ${tomcat-home}/bin; ./startup.sh;" />
		</antcall>
	</target>

	<target name="prepare">
		<antcall target="deploy-configuration-for-jetty" />
	</target>

	<target name="copy-directory-to-server">
		<scp todir="${userid}:${password}@${server-ip}:${server-directory}" trust="true" failonerror="false" verbose="${verbose}">
			<fileset dir="${directory-to-copy}" />
		</scp>
	</target>

	<target name="copy-file-to-server">
		<scp todir="${userid}:${password}@${server-ip}:${server-directory}" trust="true" failonerror="false" verbose="${verbose}">
			<fileset file="${file-to-copy}" />
		</scp>
	</target>

	<target name="execute-remote-command">
		<sshexec host="${server-ip}" trust="true" username="${userid}" password="${password}" command="${command}" failonerror="false" />
	</target>

	<target name="deploy-configuration-for-jetty" description="Copies the configuration folder to the base of the project modules so Jetty can start">
		<copy todir="code/core/ikube">
			<fileset dir="${configuration-directory}" />
		</copy>
		<copy todir="code/war/ikube">
			<fileset dir="${configuration-directory}" />
		</copy>
	</target>

</project>