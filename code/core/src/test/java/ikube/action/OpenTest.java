package ikube.action;

import static org.junit.Assert.*;
import static org.mockito.Matchers.anyString;
import static org.mockito.Mockito.when;
import ikube.ATest;
import ikube.toolkit.FileUtilities;

import java.io.File;
import java.io.IOException;

import org.junit.After;
import org.junit.Before;
import org.junit.Ignore;
import org.junit.Test;

/**
 * TODO This test does not play nicely with the other tests! Why?
 * 
 * @author Michael Couck
 * @since 21.11.10
 * @version 01.00
 */
@Ignore
public class OpenTest extends ATest {

	private transient final Open open = new Open();

	public OpenTest() {
		super(OpenTest.class);
	}

	@Before
	public void before() {
		when(INDEX_CONTEXT.getIndexDirectoryPath()).thenReturn("./" + this.getClass().getSimpleName());
		FileUtilities.deleteFile(new File(INDEX_CONTEXT.getIndexDirectoryPath()), 1);
	}

	@After
	public void after() throws Exception {
		FileUtilities.deleteFile(new File(INDEX_CONTEXT.getIndexDirectoryPath()), 1);
	}

	@Test
	public void execute() throws IOException {
		File indexDirectory = new File(INDEX_CONTEXT.getIndexDirectoryPath());
		FileUtilities.deleteFile(indexDirectory, 1);

		boolean opened = open.execute(INDEX_CONTEXT);
		assertFalse("There should be no index to open : ", opened);

		String indexDirectoryPath = getServerIndexDirectoryPath(INDEX_CONTEXT);

		INDEX_CONTEXT.getIndex().setMultiSearcher(MULTI_SEARCHER);
		when(INDEX_SEARCHER.getIndexReader()).thenReturn(INDEX_READER);
		when(INDEX_READER.directory()).thenReturn(FS_DIRECTORY);
		when(LOCK.isLocked()).thenReturn(Boolean.FALSE);
		when(FS_DIRECTORY.getFile()).thenReturn(new File(indexDirectoryPath));
		when(FS_DIRECTORY.makeLock(anyString())).thenReturn(LOCK);
		when(MULTI_SEARCHER.getSearchables()).thenReturn(SEARCHABLES);

		opened = open.execute(INDEX_CONTEXT);
		assertFalse("The index should have been opened : ", opened);

		File anotherIndexDirectory = new File(indexDirectoryPath.replace(IP, "127.0.0.2"));
		createIndex(anotherIndexDirectory);

		INDEX_CONTEXT.getIndex().setMultiSearcher(null);
		opened = open.execute(INDEX_CONTEXT);
		assertTrue("The index should have been opened : ", opened);

		FileUtilities.deleteFile(anotherIndexDirectory, 1);
		FileUtilities.deleteFile(new File(INDEX_CONTEXT.getIndexDirectoryPath()), 1);
	}

}
