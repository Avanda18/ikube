package ikube.action;

import ikube.AbstractTest;
import ikube.IConstants;
import ikube.action.index.IndexManager;
import ikube.toolkit.FileUtilities;
import org.apache.lucene.index.IndexWriter;
import org.apache.lucene.search.IndexSearcher;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.mockito.Mockito;
import org.mockito.invocation.InvocationOnMock;
import org.mockito.stubbing.Answer;

import java.io.File;

import static org.junit.Assert.assertNotSame;
import static org.junit.Assert.assertTrue;

/**
 * @author Michael Couck
 * @version 01.00
 * @since 21.11.10
 */
@SuppressWarnings("deprecation")
public class ReopenTest extends AbstractTest {

	private Reopen reopen;
	private IndexSearcher multiSearcher;

	@Before
	public void before() {
		reopen = new Reopen();
		Mockito.when(indexContext.isDelta()).thenReturn(Boolean.TRUE);
		Mockito.doAnswer(new Answer<Void>() {
			@Override
			public Void answer(final InvocationOnMock invocation) throws Throwable {
				multiSearcher = (IndexSearcher) invocation.getArguments()[0];
				return null;
			}
		}).when(indexContext).setMultiSearcher(Mockito.any(IndexSearcher.class));
	}

	@After
	public void after() throws Exception {
		FileUtilities.deleteFile(new File(indexContext.getIndexDirectoryPath()), 1);
	}

	@Test
	@SuppressWarnings("unused")
	public void internalExecute() throws Exception {
		File indexDirectory = createIndexFileSystem(indexContext, "Hello world");

		// First open the index
		new Open().execute(indexContext);

		// Add some documents to the index and reopen
		Mockito.when(indexContext.getMultiSearcher()).thenReturn(multiSearcher);
		IndexWriter[] indexWriters = IndexManager.openIndexWriterDelta(indexContext);
		addDocuments(indexWriters[0], IConstants.CONTENTS, "Michael Couck");
		boolean opened = reopen.execute(indexContext);
		assertTrue("The index should be open : ", opened);
		int docs = multiSearcher.getIndexReader().numDocs();

		// Add some more documents to the index and reopen
		addDocuments(indexWriters[0], IConstants.CONTENTS, "Michael Couck again");
		opened = reopen.execute(indexContext);
		assertTrue("The index should be open : ", opened);
		int moreDocs = multiSearcher.getIndexReader().numDocs();

		logger.info("Docs : " + docs + ", " + moreDocs);
		assertNotSame("There should be more documents in the new multi searcher : ", docs, moreDocs);
	}

}