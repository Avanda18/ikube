<?xml version="1.0" encoding="UTF-8"?>

<beans
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns="http://www.springframework.org/schema/beans"
	xmlns:aop="http://www.springframework.org/schema/aop"
	xmlns:util="http://www.springframework.org/schema/util"
	xmlns:property="http://www.springframework.org/schema/p"
	xmlns:transaction="http://www.springframework.org/schema/tx"
	xmlns:context="http://www.springframework.org/schema/context"

	xsi:schemaLocation="
			http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
			http://www.springframework.org/schema/aop
            http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
            http://www.springframework.org/schema/util
            http://www.springframework.org/schema/util/spring-util.xsd
            http://www.springframework.org/schema/context
            http://www.springframework.org/schema/context/spring-context-3.0.xsd">
            
	<description>
		This file is not to be modified by users generally.
		This is the configuration for the intercepter for the rules, the enrichment 
		intercepter for enriching the indexes with the geospatial data and the monitoring 
		intercepter that will collect statistical data in production.
	</description>
	
	<aop:aspectj-autoproxy proxy-target-class="true" />
	
	<!--
		This bean will intercept the actions, execute the rules that are associated with the 
		actions, and based on the results from the execution of the rules and the evaluation 
		of the boolean rule expression execute the action or not. 
	 -->
	<bean 
		id="ikube.action.rule.IRuleInterceptor" 
		class="ikube.action.rule.RuleInterceptor"
		init-method="initialize"
		destroy-method="destroy" />
	<aop:config proxy-target-class="true">
		<aop:aspect ref="ikube.action.rule.IRuleInterceptor">
			<aop:around method="decide" pointcut="execution(* ikube.action.*.*(..))"  />
		</aop:aspect>
	</aop:config>
	
	<!-- 
		This bean is the geocoder, it will enrich the data with spatial co-ordinates if
		the indexables contain address fields. The Url for this service  
	-->
	<bean
		id="ikube.index.spatial.geocode.Geocoder"
		class="ikube.index.spatial.geocode.Geocoder"
		property:searchFields-ref="geospatialFields" 
		property:searchUrl="${searcher.web.service.url}" />
	<util:list id="geospatialFields">
		<value>name</value>
	</util:list>
	<bean 
		id="ikube.index.spatial.enrich.IEnrichment"
		class="ikube.index.spatial.enrich.Enrichment"
		property:minKm="10"
		property:maxKm="20"  />
	<bean 
		id="ikube.index.spatial.ISpatialEnrichmentInterceptor" 
		class="ikube.index.spatial.SpatialEnrichmentInterceptor"
		property:geocoder-ref="ikube.index.spatial.geocode.Geocoder"
		property:enrichment-ref="ikube.index.spatial.enrich.IEnrichment" />
	<aop:config proxy-target-class="true">
		<!-- <aop:aspect ref="ikube.index.spatial.ISpatialEnrichmentInterceptor">
			<aop:around method="enrich" pointcut="execution(* ikube.index.handler.*.*.add*(..))" />
		</aop:aspect> -->
	</aop:config>
	
	<!-- These are just pojos that delegate to the real class that can be intercepted by Spring. -->
	<bean 
		id="ikube.service.ISearchDelegate"
		class="ikube.service.SearchDelegate" />
	<bean 
		id="ikube.index.handler.InterceptorDelegate"
		class="ikube.index.handler.InterceptorDelegate" />
	
	<!--
		This bean will intercept the searching and the indexing, specifically adding documents 
		to the Lucene index. A counter will be incremented for each document added and the 
		indexing performance can be monitored. 
	 -->
	<bean 
		id="ikube.monitoring.IMonitoringInterceptor" 
		name="ikube.monitoring.IMonitoringInterceptor"
		class="ikube.monitoring.MonitoringInterceptor" />
	<aop:config proxy-target-class="true">
		<!-- <aop:aspect ref="ikube.monitoring.IMonitoringInterceptor">
			<aop:around method="searchingPerformance" pointcut="execution(* ikube.service.SearcherWebService.search*(..))" />
		</aop:aspect> -->
		<!-- <aop:aspect ref="ikube.monitoring.IMonitoringInterceptor">
			<aop:around method="indexingPerformance" pointcut="execution(* ikube.index.handler.*.*(..))" />
		</aop:aspect> -->
		<aop:aspect ref="ikube.monitoring.IMonitoringInterceptor">
			<aop:around method="indexingPerformance" pointcut="execution(* ikube.index.handler.IndexableHandler.addDocument(..))" />
		</aop:aspect>
		<aop:aspect ref="ikube.monitoring.IMonitoringInterceptor">
			<aop:around method="indexingPerformance" pointcut="execution(* ikube.index.handler.database.IndexableTableHandler.addDocument(..))" />
		</aop:aspect>
		<!-- <aop:aspect ref="ikube.monitoring.IMonitoringInterceptor">
			<aop:around method="indexingPerformance" pointcut="execution(* ikube.index.handler..*.*(..))" />
		</aop:aspect>
		<aop:aspect ref="ikube.monitoring.IMonitoringInterceptor">
			<aop:around method="indexingPerformance" pointcut="execution(* ikube.index.handler.InterceptorDelegate.*(..))" />
		</aop:aspect> -->
		<!-- <aop:aspect ref="ikube.monitoring.IMonitoringInterceptor">
			<aop:around method="indexingPerformance" pointcut="execution(* ikube.index.handler.*.*.*(..))" />
		</aop:aspect>
		<aop:aspect ref="ikube.monitoring.IMonitoringInterceptor">
			<aop:around method="indexingPerformance" pointcut="execution(* ikube.index.handler..*.*(..))" />
		</aop:aspect>
		<aop:aspect ref="ikube.monitoring.IMonitoringInterceptor">
			<aop:around method="indexingPerformance" pointcut="execution(* ikube.index.handler...*(..))" />
		</aop:aspect> -->
	</aop:config>
	
	<!-- The handlers that do the indexing logic. -->
	<bean
		id="ikube.index.handler.IHandler"
		class="ikube.index.handler.IHandler"
		abstract="true" />
	<bean 
		id="ikube.index.handler.IndexableHandler"
		parent="ikube.index.handler.IHandler"
		class="ikube.index.handler.IndexableHandler" 
		abstract="true" />
	<bean
		parent="ikube.index.handler.IndexableHandler"
		class="ikube.index.handler.internet.IndexableInternetHandler"
		property:threads="${internet.handler.threads}" 
		property:indexableClass="ikube.model.IndexableInternet" />
	<bean
		parent="ikube.index.handler.IndexableHandler"
		class="ikube.index.handler.email.IndexableEmailHandler"
		property:threads="${email.handler.threads}"
		property:indexableClass="ikube.model.IndexableEmail" />
	<bean
		parent="ikube.index.handler.IndexableHandler"
		class="ikube.index.handler.filesystem.IndexableFilesystemHandler"
		property:threads="${filesystem.handler.threads}"
		property:indexableClass="ikube.model.IndexableFileSystem" />
	<bean
		parent="ikube.index.handler.IndexableHandler"
		class="ikube.index.handler.database.IndexableTableHandler"
		property:threads="${table.handler.threads}"
		property:indexableClass="ikube.model.IndexableTable" />
	<bean
		parent="ikube.index.handler.IndexableHandler"
		class="ikube.index.handler.filesystem.IndexableDictionaryHandler"
		property:threads="${filesystem.handler.threads}"
		property:indexableClass="ikube.model.IndexableDictionary" />
	
</beans>