<?xml version="1.0" encoding="UTF-8"?>

<beans
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns="http://www.springframework.org/schema/beans"
	xmlns:aop="http://www.springframework.org/schema/aop"
	xmlns:util="http://www.springframework.org/schema/util"
	xmlns:property="http://www.springframework.org/schema/p"
	xmlns:transaction="http://www.springframework.org/schema/tx"
	xmlns:context="http://www.springframework.org/schema/context"
	
	xsi:schemaLocation="
		http://www.springframework.org/schema/beans
		http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
		http://www.springframework.org/schema/aop
		http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
		http://www.springframework.org/schema/util
		http://www.springframework.org/schema/util/spring-util.xsd
		http://www.springframework.org/schema/context
		http://www.springframework.org/schema/context/spring-context-3.0.xsd">
	
	<description>TODO</description>
	
	<context:property-placeholder
		location="classpath:*/**/spring.properties" 
		properties-ref="ikube.toolkit.PropertyConfigurer" />
	
	<bean 
		id="ikube.toolkit.Logging" 
		class="org.springframework.beans.factory.config.MethodInvokingFactoryBean"
		property:staticMethod="ikube.toolkit.Logging.configure" />

	<!-- This bean will look through the classpath and load every Spring properties file it finds. -->
	<bean
		id="ikube.toolkit.PropertyConfigurer"
		class="ikube.toolkit.PropertyConfigurer"
		property:fileNamePattern="spring.properties"
		lazy-init="false"
		init-method="initialize" />
	
	<!-- Turn on AspectJ @Configurable support -->
	<context:spring-configured />
	<context:component-scan base-package="ikube" />
	
	<import resource="**/spring-*.xml" />
	
	<bean 
		class="ikube.deploy.Deployer"
		property:parallel="false"
		property:maxWaitTime="600"
		property:servers-ref="servers" />
	
	<util:list id="servers">
		<ref local="server-one" />
		<ref local="server-two" />
		<!-- <ref local="server-three" />
		<ref local="server-four" /> -->
	</util:list>
	
	<bean 
		id="server-one"
		name="server-one"
		class="ikube.deploy.model.Server"
		property:ip="ikube.be"
		property:username="${username}"
		property:password="${password}"
		property:actions-ref="actions" />
	<bean 
		id="server-two"
		name="server-two"
		class="ikube.deploy.model.Server"
		property:ip="192.168.1.10"
		property:username="${username}"
		property:password="${password}"
		property:actions-ref="actions" />
	<bean 
		id="server-three"
		name="server-three"
		class="ikube.deploy.model.Server"
		property:ip="192.168.1.20"
		property:username="${username}"
		property:password="${password}"
		property:actions-ref="actions" />
	<bean 
		id="server-four"
		name="server-four"
		class="ikube.deploy.model.Server"
		property:ip="192.168.1.31"
		property:username="${username}"
		property:password="${password}"
		property:actions-ref="actions" />
	
	<util:list id="actions">
		<ref local="stop-action" />
		<ref local="copy-action" />
		<ref local="start-action" />
	</util:list>
	
	<bean 
		id="stop-action"
		name="stop-action"
		class="ikube.deploy.action.CommandAction"
		property:breakOnError="true"
		property:commands-ref="stop-commands" />
	<util:list id="stop-commands">
		<value>. /etc/profile;</value>
		<value>cd ${tomcat-bin-directory};</value>
		<value>./catalina.sh stop;</value>
		<value>sleep 10;</value>
		<value>ps -ef | grep apache-tomcat-7.0.33-8090 | grep -v grep | awk '{print $2}' | xargs kill -9;</value>
		<value>chmod 777 -R ${tomcat-directory};</value>
		<value>rm -rf ${tomcat-directory}/bin/ikube;</value>
		<value>rm -rf ${tomcat-directory}/webapps/ikube*;</value>
		<value>rm -rf ${tomcat-directory}/logs;</value>
		<value>rm -rf ${tomcat-directory}/temp;</value>
		<value>rm -rf ${tomcat-directory}/work/Catalina/localhost;</value>
		<value>mkdir -p ${tomcat-directory}/bin/ikube;</value>
		<value>mkdir -p ${tomcat-directory}/logs;</value>
		<value>mkdir -p ${tomcat-directory}/temp;</value>
		<value>mkdir -p ${tomcat-directory}/work/Catalina/localhost;</value>
		<value>chmod 777 -R ${tomcat-directory};</value>
	</util:list>
	
	<bean 
		id="copy-action"
		name="copy-action"
		class="ikube.deploy.action.CopyAction"
		property:breakOnError="true"
		property:files-ref="files"
		property:directories-ref="directories" />
	<util:map id="files">
		<entry key="${target-directory}/${ikube-war}"  value="${tomcat-directory}/webapps" />
	</util:map>
	<util:map id="directories">
		<entry key="${configuration-directory}" value="${tomcat-directory}/bin" />
	</util:map>
	
	<bean 
		id="start-action"
		name="start-action"
		class="ikube.deploy.action.CommandAction"
		property:breakOnError="true"
		property:commands-ref="start-commands" />
	<util:list id="start-commands">
		<value>. /etc/profile;</value>
		<value>chmod 777 -R ${tomcat-directory};</value>
		<value>cd ${tomcat-bin-directory};</value>
		<value>./catalina.sh start;</value>
	</util:list>
	
</beans>