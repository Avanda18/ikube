package ikube.action;

import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertTrue;
import static org.mockito.Matchers.anyString;
import static org.mockito.Mockito.when;

import ikube.action.Close;
import ikube.action.Open;
import ikube.toolkit.FileUtilities;

import java.io.File;

import org.junit.Test;



public class OpenTest extends BaseActionTest {

	private Open open = new Open();
	private Close close = new Close();

	@Test
	public void execute() throws Exception {
		File baseIndexDirectory = FileUtilities.getFile(indexContext.getIndexDirectoryPath(), Boolean.TRUE);
		FileUtilities.deleteFile(baseIndexDirectory, 1);

		boolean opened = open.execute(indexContext);
		assertFalse(opened);
		close.execute(indexContext);

		String filePath = baseIndexDirectory.getAbsolutePath() + File.separator + System.currentTimeMillis();
		File latestIndexDirectory = FileUtilities.getFile(filePath, Boolean.TRUE);
		File serverIndexDirectory = createIndex(latestIndexDirectory, indexContext.getServerName());

		indexContext.setMultiSearcher(multiSearcher);
		when(indexSearcher.getIndexReader()).thenReturn(indexReader);
		when(indexReader.directory()).thenReturn(fsDirectory);
		when(lock.isLocked()).thenReturn(Boolean.FALSE);
		when(fsDirectory.getFile()).thenReturn(new File(serverIndexDirectory.getAbsolutePath()));
		when(fsDirectory.makeLock(anyString())).thenReturn(lock);
		when(multiSearcher.getSearchables()).thenReturn(searchables);

		opened = open.execute(indexContext);
		assertFalse(opened);
		close.execute(indexContext);

		createIndex(latestIndexDirectory, indexContext.getServerName() + "Another");

		indexContext.setMultiSearcher(null);
		opened = open.execute(indexContext);
		assertTrue(opened);
		close.execute(indexContext);

		FileUtilities.deleteFile(baseIndexDirectory, 1);
	}

}
